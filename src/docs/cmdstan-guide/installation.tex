\chapter{Installation and Compatibility}\label{install.appendix}

\noindent
This appendix describes the hardware and software required to run
\CmdStan.  The software required includes \CmdStan and its libraries,
as well as a contemporary \Cpp compiler.  \CmdStan requires hardware
powerful enough to build and execute the models.  Ideally, that will
be a 64-bit computer with at least 4GB of memory and multiple
processor cores.

\section{Operating System}

\CmdStan is written in portable \Cpp without {\Cpp}11 features, as are the
libraries on which it depends.  Therefore, \CmdStan should run on any machine
for which a suitable \Cpp compiler is available.  In practice, \CmdStan,
like the Boost and Eigen libraries on which it depends, is very hard
on the compiler and linker.

\CmdStan has been tested on the following operating systems.
%
\begin{itemize}
\item Linux (Debian, Ubuntu, Red Hat), 
\item Mac OS X (10.10 ``Yosemite,'' 10.9 ``Mavericks,'' 10.8
  ``Mountain Lion,'' 10.7 ``Lion,'' and 10.6 ``Snow Leopard'')
\item Windows (XP, 7, 8).
\end{itemize}
%
\CmdStan should work on other versions of these operating systems if
compatible \Cpp compilers can be found.  The plan is to keep up with
new versions of these operating systems and gradually phase out
testing on older versions.

\section{Required Software and Tools}

The only two absolute requirements for running \CmdStan are the
\CmdStan source code (and dependent libraries) and a \Cpp compiler.

\subsection{\CmdStan Source}

In order to compile \Stan program, the \CmdStan source code is
required.  The \CmdStan source code distribution includes \CmdStan's
source code, \Stan's source code, documentation, build scripts, unit
tests, example models models, documentation and source for the
required libraries Boost and Eigen, and the source for an optional
testing library, Google Test.

\subsubsection{CmdStan: Stable Releases}

The latest release version of \CmdStan can be downloaded
from the CmdStan home page:
%
\begin{quote}
\url{http://mc-stan.org/cmdstan.html}
\end{quote}
%

\subsubsection{CmdStan: Development Source Control}

The source code repository is hosted by GitHub, and contains the
latest versions of CmdStan (and Stan) underdevelopment.  See:
%
\begin{quote}
http://mc-stan.org/source-repos.html
\end{quote}

\subsubsection{Boost C++ Library Source}

\Stan's parser and some of its mathematical functions and template
metaprogramming facilities are implemented with the Boost \Cpp
Library.
%
\begin{itemize}
\item Home: \url{http://www.boost.org/users/license.html}
\item License: Boost Software License
\item Tested Version: 1.54.0
\end{itemize}
%
The Boost source code is distributed with \Stan.


\subsubsection{Eigen Matrix and Linear Algebra Library Source}

\Stan's matrix algebra depends on the Eigen \Cpp matrix and linear
algebra library.  
%
\begin{itemize}
\item Home: \url{http://eigen.tuxfamily.org}
\item License: Mozilla Public License, version 2.0
\item Tested Version: 3.2.0
\end{itemize}
%
The Eigen source code is distributed with \Stan.


\subsection{\Cpp Compiler}

Compiling \CmdStan programs requires a \Cpp compiler.  \CmdStan has been
primarily developed with \clang and \gpp and no promises are made for
other compilers.  The full set of compilers for which \CmdStan has been
tested is
%
\begin{itemize}
%
\item \gpp
\\
Tested Versions: Mac 4.2.1, 4.6, Linux 4.4--4.7 (plus trunk 4.8, 4.9), Windows 4.6.3
\\
Home: \url{http://gcc.gnu.org/}
\\
License: GPL3+
%
\item \clang, Mac 2.9--3.1, Linux 2.9--3.1
\\
Home: \url{http://clang.llvm.org/}
\\
License: BSD
%
\item mingw-64, version 2.0 (Windows 7, cross-compiled from Debian Linux)
%
\item Intel \Cpp, Linux version 12.1.3
%
\end{itemize}
%


\section{Step-by-Step Windows Install Instructions}\label{install-windows.appendix}

\CmdStan has been tested on Windows XP, Windows 7, and Windows 8.

\CmdStan also runs under Cygwin, which provides a unix-like shell on top
of Windows.  Instructions for Cygwin installation are provided below
in their own subsection.


\subsection{Windows Tips}


\subsubsection{Opening a Command Shell}

To open a Windows command shell, first open the \code{Start Menu}
(usually in the lower left of the screen), select option
\code{All Programs}, then option \code{Accessories}, then
program \code{Command Prompt}.

Alternatively, enter \code{[Windows+r]} (both keys together on the
keyboard), and enter \code{cmd} into the text field that pops up in
the Run window, then press \code{[Return]} on the keyboard to run.

\subsubsection{32-bit Builds}

\CmdStan defaults to a 64-bit build. On a 32-bit operating system,
include \verb|BIT=32| in \code{make/local}. See
\refappendix{make-options} for more details.

\subsection{Rtools C++ Development Environment}

The simplest way to install a full \Cpp build environment that will
work for \CmdStan is to use the Rtools package designed for R
developers on Windows (even if you don't plan to use R).

First, download the latest \emph{frozen} (i.e., stable) version of
Rtools from the Rtools home page, using
%
\begin{quote}
\url{http://cran.r-project.org/bin/windows/Rtools/}
\end{quote}
%
Next, double click on the downloaded file to open the Rtools
install wizard, then proceed through its options.
\begin{itemize}
\item \emph{Language}: select language, click \code{Next},
\item \emph{Welcome}: click \code{Next},
\item \emph{Information}: click \code{Next},
\item \emph{Setup Location}: accept default (\Verb|c:\Rtools|), click \code{Next},
\item \emph{Select Components}: select default, \code{Package
   Authoring}, click \code{Next},
\item \emph{Select Additional Tasks}: check \code{Edit Path} and \code{Save
 Version in Registry}, click \code{Next},
\item \emph{System Path Report}: ensure that that the paths to \code{c:\textbackslash{}Rtools\textbackslash{}bin} and \code{c:\textbackslash{}Rtools\textbackslash{}gcc-4.6.3\textbackslash{}bin} are listed at the beginning of the path and click \code{Next},
\item \emph{Ready to Install}: click \code{Next}, wait for the
  install to complete, then
\item \emph{Finish}: click \code{Finish}.
\item \emph{Confirm Path}: After the install has completed, open a command prompt and type \code{PATH} to ensure that the new path is activated and the Rtools folders are in the system path.
\end{itemize}

\subsubsection{Checking the Path}

Make sure that \Verb|c:\Rtools\bin| has been added to your \Verb|PATH|
environment variable, and then open another command window.  You
should be able to follow the last step, \emph{Comfirm Path}, above.

\subsection{Verifying Tools}

To verify that \gpp is installed, use the following command.
%
\begin{quote}
  \Verb|> g++ -v|
\end{quote}
%
This should report version information for \gpp.  Next, verify that
\code{make} is installed with the following command.
%
\begin{quote}
  \Verb|> make -v|
\end{quote}
%
This should print version information for make.

\subsection{Downloading and Unpacking \CmdStan}

The \CmdStan source code distribution is named
\code{cmdstan-\cmdstanversion.tar.gz}; the versions here are major version 2,
minor version 6, and patch level 0.  Download the latest \CmdStan
source tarball from the \CmdStan downloads page,
%
\begin{quote}
\url{https://github.com/stan-dev/cmdstan/releases}
\end{quote}
%
to any non-temporary folder.  (If in doubt, select \code{My Documents}
on Windows XP or \code{Documents} on Windows 7.)  

Change to the download directory (aka folder) using one of the
following commands, replacing \code{<username>} with
a Windows user name.
%
\begin{itemize}
\item \emph{Windows XP}: \ From the default starting directory, use
the following commands (quotes and all):
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> cd "My Documents"
\end{Verbatim}
\end{quote}
%
The full path (including quotes) will work from anywhere,
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> cd "c:\Documents and Settings\<username>\My Documents"
\end{Verbatim}
\end{quote}
\item \emph{Windows 7}:  \  From the default starting directory, use
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> cd Documents
\end{Verbatim}
\end{quote} 
or use the full path, including quotes, from anywhere,
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> cd "c:\Users\<username>\Documents"
\end{Verbatim}
\end{quote}
\end{itemize}
%
To verify that the downloaded \CmdStan \code{.tar.gz} file is there,
list the directory contents using:
%
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> dir
\end{Verbatim}
\end{quote}

Finally, unpack the distribution using the \code{tar} command (which
is installed as part of Rtools).
%
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> tar --no-same-owner -xzf cmdstan-\cmdstanversion.tar.gz 
\end{Verbatim}
\end{quote}
%
The \code{--no-same-owner} flag is not strictly necessary,
but it removes a bunch of irrelevant warnings.


\subsection{64-bit Cygwin Install Instructions}

\CmdStan can be run under Cygwin, the Unix look-and-feel environment
for Windows.  Cygwin must have recent versions of \code{make} and
\code{g++} (part of gcc) installed.  Within a Cygwin shell, \CmdStan
will behave as under other Unixes. Follow the directions in
\refappendix{install-linux}.



\section{Step-by-Step Mac Install Instructions}\label{install-mac.appendix}

This section provides step-by-step install instructions for the Mac.
\CmdStan has been tested on Mac OS X versions Mavericks, Snow Leopard,
Lion, and Mountain Lion.

\subsection{Install Xcode C++ Development Environment}

The easiest (but not the only) way to install a \Cpp development
environment on a Mac is to use Apple's Xcode development environment.

From the Xcode home page, 
%
\begin{quote}
\url{https://developer.apple.com/xcode/}
\end{quote}
%
click \code{View in Mac App Store}.

From the App Store, click \code{Install}, enter an Apple ID,
and wait for Xcode to finish installing.

Open the Xcode application, click top-level menu
\code{Preferences}, click top-row button \code{Downloads},
click button for \code{Components}, click on the \code{Install}
button to the right of the \code{Command Line Tools} entry, then
wait for it to finish installing.  

Click the top-level menu item \code{Xcode}, then click item 
\code{Quit Xcode} to quit.

To test, open the Terminal application and enter

\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> make --version
> g++ --version
\end{Verbatim}
\end{quote}
%
Verify that \code{make} is at version 3.81 or later and \code{g++}
is at 4.2.1 or later.


\subsection{Download and Unpack \CmdStan Source}

Download the most recent version of \code{cmdstan-\cmdstanversion.tar.gz} from
the \CmdStan downloads list,
%
\begin{quote}
\url{https://github.com/stan-dev/cmdstan/releases}
\end{quote}

Open the folder containing the download in the Finder
(typically, the user's top-level \code{Downloads} folder).

If the Mac OS has not automatically unpacked the \code{.tar.gz}
file into file \code{cmdstan-\cmdstanversion.tar},
double-click the \code{.tar.gz} file to unpack.

Double click on the \code{.tar} file to unarchive
directory \code{cmdstan-\cmdstanversion}.

Move the resulting directory to a location where it will not be
deleted, henceforth called \code{<cmdstan-home>}.


\section{Step-by-Step Linux Install Instructions}\label{install-linux.appendix}

\CmdStan has been tested on various Linux installations, including
Ubuntu, Debian, and Red Hat.

\subsection{Installing C++ Development Tools}

On Linux, \Cpp compilers and \code{make} are often installed by
default.

To see if the \code{g++} compiler and \code{make} build system
are already installed, use the commands
%
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> g++ --version
> make --version
\end{Verbatim}
\end{quote}
%
If these are at least at \code{g++} version 4.2.1 or later and
\code{make} version 3.81 or later, no additional installations are
necessary.  It may still be desirable to update the \Cpp compiler
\code{g++}, because later versions are faster.

To install the latest version of these
tools (or upgrade an older version), use the commands
%
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> sudo apt-get install g++ 
> sudo apt-get install make 
\end{Verbatim}
\end{quote}
% 
A password will likely be required by the superuser command \code{sudo}.


\subsection{Downloading and Unpacking \CmdStan Source}

Download the most recent stable version of \CmdStan,
\code{cmdstan-\cmdstanversion.tar.gz}, from the \CmdStan downloads page,
%
\begin{quote}
\url{https://github.com/stan-dev/cmdstan/releases}
\end{quote}
%
to the directory where Stan will reside.

In a command shell, change directories to where the tarball was
downloaded, say \code{<download-dir>}, with
%
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> cd <download-dir>
\end{Verbatim}
\end{quote}
%
where \code{<download-dir>} is replaced with the actual path to the directory.

Then, unpack the distribution into the subdirectory
\begin{quote}
\nolinkurl{<download-dir>/cmdstan-\cmdstanversion}
\end{quote}
%
with
%
\begin{quote}
\begin{Verbatim}[fontshape=sl,fontsize=\small]
> tar -xzf cmdstan-\cmdstanversion.tar.gz
\end{Verbatim}
\end{quote}


\section{{\tt make} Options}\label{make-options.appendix}

\subsection{Setting a Variable}
\CmdStan uses \code{make} for building the \CmdStan tools and
compiling \Stan programs as executables. Users can customize how the
tools are built by editing \code{make/local} inside the
\code{<cmdstan-home>} directory.

Customization is done by setting variables or appending to them. For
each variable that needs to be set, write \Verb|<variable>=<value>| on
its own line inside \code{make/local}. To append to existing
variables, write \Verb|<variable>+=<value>|.

\subsection{Customizing {\tt make} Options}

\subsubsection{Compiler Settings}

The most common options to set are the compiler options:
%
\begin{itemize}
  \item \Verb|CC|. The compiler used to build \CmdStan and the \Stan
    executables. The default is \Verb|CC=g++|.
  \item \Verb|O|. The optimization level for the compiler. The default
    is \Verb|O=3|. Both \gpp and \clang recognize \Verb|0,1,2,3|, and
    \Verb|s|.
\end{itemize}

\subsubsection{Changing Library Locations}

The next set of variables allow for easy replacement of dependent
libraries. \CmdStan depends on \Stan, Boost, and Eigen. Although
\CmdStan is bundled with a particular verison of \Stan, other versions
can be used. The same is true with Boost and Eigen.

The \Stan developers typically replace the tagged version of \Stan in
\code{<cmdstan-home>/stan} with an updated version and do not set
these variables. That said, it is easy to point \CmdStan to other versions
of these libraries in other directories.
%
\begin{itemize}
  \item \Verb|STANAPI_HOME|. The location of the \Stan source
    directory. The default is \Verb|STANAPI_HOME=stan/|. Note: the
    trailing forward slash is necessary.
  \item \Verb|BOOST|. The location of the Boost library. The default
    is \Verb|BOOST=stan/lib/boost_1.54.0|. If \Verb|STANAPI_HOME| is
    set, the default will be the \Verb|lib/boost_1.54.0| folder within
    \Verb|STANAPI_HOME|.
  \item \Verb|EIGEN|. The location of the Eigen library. The default
    is \Verb|EIGEN=stan/lib/eigen_3.2.0|. If \Verb|STANAPI_HOME| is
    set, the default will be the \Verb|lib/eigen_3.2.0| folder within
    \Verb|STANAPI_HOME|.
\end{itemize}
%

\subsubsection{Additional Options}

These are the additional options and typically do not need to be set.
%
\begin{itemize}
  \item \Verb|O_STANC|. The optimization level for building
    \code{stanc}. The default is \Verb|O_STANC=0|.
  \item \Verb|CFLAGS|. The compiler flags for building \CmdStan
    programs. The default value is dependent on the operating system.
  \item \Verb|LDLIBS|. The libraries used for linking \CmdStan
    programs. The default value is dependent on the operating system.
  \item \Verb|LDLIBS_STANC|. The libraries used for linking the \Stan
    compiler, \code{stanc}. The default is the value of \Verb|LDLIBS|.
  \item \Verb|BIT|. The bitness of the executable. This variable only
    applies to Windows. The default is \Verb|BIT=64|. If building on a
    32-bit Windows machine, \Verb|BIT=32| must be set.
  \item \Verb|TEMPLATE_DEPTH|. The maximum instantiation depth for
    template classes which is passed to \gpp or \clang. This variable
    only applies to Mac OS X due to the current compilers distributed
    through Xcode not specifying enough depth by default.
  \item \Verb|EXE|. The file extension for executables. The default is
    operating system dependent. On Windows, the default is
    \Verb|EXE=.exe|. On other operating systems, the default is empty,
    \Verb|EXE=|.
\end{itemize}
%

\subsection{Rebuildling \CmdStan}

When compiler flags are changed, \CmdStan needs to be rebuilt in order
for the changes to take place. The easiest way to do this is to type:
%
\begin{quote}
  \begin{Verbatim}[fontshape=sl]
> make clean-all
  \end{Verbatim}
\end{quote}
%
Then rebuild \CmdStan and the \Stan programs of interest.


\section{MKL Compiler Instructions}

\subsection{Getting the MKL}

To purchase a license, see
%
\begin{quote}
\url{http://software.intel.com/en-us/intel-mkl}
\end{quote}
%
For non-commercial development, see
%
\begin{quote}\small
\url{http://software.intel.com/non-commercial-software-development}
\end{quote}

\subsection{Compiling with MKL}

In order to use Intel's math kernel library (MKL) for \Cpp, a few
lines need to be added to \code{make/local}. 
\begin{itemize}
  \item \Verb|CC = icc|. Set the compiler to icc.
  \item \Verb|MKLROOT = /apps/intel/2013/mkl|. Create a new variable
    with the location of the MKL path.
  \item
    \Verb|CFLAGS += -I $(MKLROOT)/include -DEIGEN_USE_MKL_ALL|. This
    tells Eigen to use MKL and where to find the necessary header
    files.
  \item \Verb|LDLIBS += -L$(MKLROOT)/lib/intel64 -lmkl_intel_lp64| and
    \Verb|LDLIBS += -lmkl_core -lmkl_sequential -lpthread -lm|. This
    links in the MKL library for the \CmdStan executables. The exact
    implementation will depend on the particular system. Use the MKL
    link line advisor for help.
\end{itemize}
%
{\it Note:} \ Make sure to do the above changes before compiling for the first
time - otherwise Stan will be compiled with \code{g++} and you won't see any
performance gains.  


\section{Optional Components for Developers}

\CmdStan is developed using the following set of tools.  The various
command examples in this manual have assumed they can be found on
the command path.  The makefile allows precise locations to be plugged
in. 

\subsection{GNU Make Build Tool}

\CmdStan automates the build, test, documentation, and deployment tasks
using scripts in the form of makefiles to run with GNU Make.
%
\begin{itemize}
\item Home: \url{http://www.gnu.org/software/make}
\item License: GPLv3+
\item Tested Versions: 3.81 (Mac OS X), 3.79 (Windows 7)
\end{itemize}
%


\subsection{Doxygen Documentation Generator}

\CmdStan's API documentation is generated using the Doxygen Tool.
%
\begin{itemize}
\item Home: \url{http://www.stack.nl/~dimitri/doxygen/index.html}
\item License: GPL2
\item Tested Version(s): Mac OS X 1.8.2, Windows 1.8.2
\end{itemize}


\subsection{Git Version Control System}

\CmdStan uses the Git version control system for its software, libraries,
and documentations.  Git is required to interact with the most recent
versions of code in the version control repository.
% 
\begin{itemize}
\item Home: \url{http://git-scm.com/}
\item License: GPL2
\item Tested Version(s): Mac versions 1.8.2.3 and 1.7.8.4; Windows version 1.7.9
\end{itemize}


\subsubsection{Google Test C++ Testing Framework}

\CmdStan's unit testing is based on the Google's googletest \Cpp testing
framework.  
%
\begin{itemize}
\item
Home: \url{http://code.google.com/p/googletest/}
\item
License: BSD
\item
Tested Version(s): 1.7.0
\end{itemize}
%
The Google Test framework is distributed with \Stan.


\section{Tips for Mac OS X}

\subsubsection{Finding and Opening Mac Applications and Files}

To open an application, use \code{[Command-Space]} (press both keys at
once on the keyboard) to open Spotlight, enter the application's name
in the text field, then click on the application in the pop-up menu or
\code{[Return]} if the right file or application is highlighted.

Spotlight can be used in the same way to find files or folders,
such as the default \code{Downloads} folder for web downloads.

\subsubsection{Open a Terminal for Shell Commands}

To run shell commands, open the built-in Terminal application (see the
previous subsection for details on how to find and open applications).

\subsection{Install Xcode}

Apple's Xcode contains both the \clang and \gpp compilers and make,
all of the tools needed to work with \CmdStan as a user.  The version
of Xcode to install depends on the version of Mac OS X.

\subsubsection{Alternative, GCC-Only Installer}

A stripped down installer for just the GCC package, including the \Cpp
compilers \code{g++} and \code{clang++}, available for Mac OS X 10.6
(``Snow Leopard'') or later,
%
\begin{quote}
\url{https://github.com/kennethreitz/osx-gcc-installer/}
\end{quote}
%
The fill list of tools in this distribution is available at:
%
\begin{quote}
\url{http://www.opensource.apple.com/release/developer-tools-41/}
\end{quote}


\subsection{More Recent Compilers}

Alternative compilers to those distributed by Apple as part of Xcode
are available at the following locations.

\subsubsection{Homebrew}

One way to get pre-built binaries for Mac OS X is to use Homebrew,
which is available from the following link.
\begin{quote}
\url{http://mxcl.github.com/homebrew/}
\end{quote}

\subsubsection{MacPorts}

MacPorts hosts recent versions of compilers for the Macintosh.
%
\begin{quote}
\url{https://distfiles.macports.org/MacPorts/}
\end{quote}
%
After finding the appropriate \code{.dmg} file, clicking on it, then
double clicking on the resulting \code{.pkg} file, and clicking
through some more menus, the following will need to be entered from a
terminal window to install it.
%
\begin{quote}
\code{> sudo port install {\slshape gccVersion}}
\end{quote}
%
In this command, {\slshape gccVersion} is the name of a compiler
version, such as \code{g++=mp-4.6}, for version 4.6.  Errors may arise
during the install such as the following.
%
\begin{quote}\small\tt
  Error: Target org.macports.activate returned: Image error:
  /opt/local/include/gmp.h already exists and does not belong to a
  registered port.  Unable to activate port gmp. Use 'port -f activate
  gmp' to force the activation.
\end{quote}
%
This issue can be resolved by running the following command.
%
\begin{quote}
\code{> sudo port -f activate gmp}
\end{quote}
%

\subsection{\LaTeX\ Typesetting Package}

\CmdStan uses the \LaTeX\ typesetting package for generating manuals,
talks, and other materials (Doxygen is used for API documentation; see
below).  The first step is to download the MacTeX \code{.mpkg} file
from the following URL [warning: the download is approximately 2GB and
the installation approximately 3.5GB].
%
\begin{quote}
\url{http://www.tug.org/mactex/2011/}
\end{quote}
%
Once it is downloaded, just click on the \code{.mpkg} file and then
follow the installer instructions.  The installer will add the command
to the \code{PATH} environment variable so that the \code{pdflatex}
used by \Stan is available from the command line.


\subsection{Lucida Console Font}

A free TrueType version of Lucida Console for the Mac is available
at the following URL.
%
\begin{quote}
\url{http://www.fontpalace.com/font-details/Lucida+Console/}
\end{quote}
%
Download the \code{.ttf} file, then click on it to install.  It
will then be available as a preference in the Mac terminal application.
