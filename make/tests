##
# LIBGTEST is the google test library
# GTEST_MAIN is the file that contains the google test
##
LIBGTEST = test/libgtest.a
GTEST_MAIN = $(GTEST)/src/gtest_main.cc
CFLAGS_GTEST += -I $(GTEST)/include -I $(GTEST)

##
# Build the google test library.
## 
$(LIBGTEST): $(LIBGTEST)(test/gtest.o)

test/gtest.o: $(GTEST)/src/gtest-all.cc
	@echo '--- compile $(LIBGTEST) ---'
	@mkdir -p test
	$(COMPILE.c) -O$O $(CFLAGS_GTEST) $< $(OUTPUT_OPTION)


##
# Rule for building a test
##
test/%.o : src/test/%_test.cpp $(LIBGTEST)
	@echo '-*- compile $@'
	@mkdir -p $(dir $@)
	$(COMPILE.c) -O$O $(CFLAGS_GTEST) $< $(OUTPUT_OPTION)

##
# Rule for building a test executable
##
test/%$(EXE) : test/%.o
	@echo '-*- link $@'
	@mkdir -p $(dir $@)
	$(LINK.c) -O$O $(GTEST_MAIN) $< $(CFLAGS_GTEST) $(OUTPUT_OPTION) $(LIBGTEST) $(LDLIBS)





############################################################
##
# Target to verify cmdstan header files
##
HEADER_TESTS := $(addsuffix -test,$(shell find $(CMDSTAN_HOME)src/cmdstan -name '*.hpp' -type f)) 

ifeq ($(OS_TYPE),win) 
  DEV_NULL = nul
else
  DEV_NULL = /dev/null
endif

.PHONY: HEADER_TESTS
%.hpp-test : %.hpp test/dummy.cpp
	$(COMPILE.c) -O0 -include $< -o $(DEV_NULL) test/dummy.cpp

test/dummy.cpp:
	@mkdir -p test
	@touch $@
	@echo "int main() {return 0;}" >> $@

.PHONY: test-headers
test-headers: $(HEADER_TESTS)


############################################################
##
# All interface tests depend on certain compiled models
##
test/interface/command_test.o: $(addsuffix $(EXE),$(addprefix src/test/test-models/, printer domain_fail proper value_fail))
test/interface/csv_header_consistency_test.o: src/test/test-models/csv_header_consistency$(EXE)
test/interface/fixed_param_sampler_test.o: $(addsuffix $(EXE),$(addprefix src/test/test-models/, empty proper))
test/interface/optimization_output_test.o: src/test/test-models/optimization_output$(EXE)
test/interface/print_test.o: src/test/interface/matrix_output.csv bin/print$(EXE)
test/interface/print_uninitialized_test.o: src/test/test-models/print_uninitialized$(EXE)
test/interface/services/argument_configuration_test.o: src/test/test-models/test_model$(EXE)
test/interface/elapsed_time_test.o: src/test/test-models/test_model$(EXE)
